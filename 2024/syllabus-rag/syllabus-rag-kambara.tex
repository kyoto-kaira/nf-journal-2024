\section{探索方法の基本情報と目的}
この章では、京大シラバス検索RAGシステムの検索手法の実験結果を報告する。
今回は検索埋め込みベクトルを用いる方法と、単語出現頻度を用いる手法の2つを実験した。

\subsection{埋め込みベクトルによる方法}
この手法は、文書を多次元のベクトル空間上のベクトルとして数値表現したデータを用いて、ベクトル間の距離や類似度によって文書を検索する。

今回は \texttt{HuggingFaceEmbeddings} を用いて埋め込みを計算した。埋め込みの計算等は第\ref{chap:syllabus-rag-overview}章の担当者にやっていただいており、ここではその後の検索手法について実験している。
具体的には、\texttt{langchain} の \texttt{vectorstore} の \texttt{as\_retriever} メソッドに備え付けられているコサイン類似度による検索と、Maximal Marginal Relevance (MMR) による検索を実験した。

\subsection{単語出現頻度に基づいた検索手法}
文書を単語分割したデータを用いて、単語の出現頻度に基づいた \texttt{BM25} という手法を実験した。

日本語は英語と異なり、空白で単語を分割することができないため、Pythonの日本語形態素解析エンジンである \texttt{janome} を用いて単語分割を行った。

\section{埋め込みベクトル探索方法の実験}
\subsection{手法}
チャンク分けの仕方が異なる3つのデータセットに対して、コサイン類似度とMMRの探索手法をいくつかのクエリに対して実験した。
チャンクの分け方は以下の3通りである。

\begin{itemize}
 \item data1 -- 「授業の概要・目的」「到達目標」「授業計画と内容」「履修要件」「成績評価の方法・観点」「教科書」のすべての項目を1つのチャンクとする。つまり、1科目1チャンクとなる。
 \item data2 -- 「授業の概要・目的」を1つのチャンク、「到達目標」を1つのチャンク、「授業計画と内容」を1つのチャンク、「履修要件」「成績評価の方法・観点」「教科書」を1つのチャンクとする。つまり、1科目4チャンクとなる。
 \item data3 -- 「授業の概要・目的」「到達目標」を1つのチャンク、「到達目標」「授業計画と内容」を1つのチャンク、「授業計画と内容」「履修要件」「成績評価の方法・観点」「教科書」を1つのチャンク、「履修要件」「成績評価の方法・観点」「教科書」「授業の概要・目的」を1つのチャンクとする。つまり、1科目4チャンクとなる。
\end{itemize}

\subsection{コサイン類似度}
コサイン類似度とは、2つのベクトルがどの程度似ているか表す尺度である。
式\ref{eq:cosine_similarity}のように、2つのベクトルの内積を2つのベクトルの大きさで割ることで得られる。

\begin{equation}\label{eq:cosine_similarity}
 \text{cos\_similarity}(x, y) = \frac{x \cdot y}{\|x\| \|y\|}
\end{equation}

\subsection{MMR(周辺関連性最大化; Maximal marginal relevance)}
MMR（Maximal Marginal Relevance）\cite{carbonell1998use}は、検索結果の多様性を広げることを目的とした手法である。
この手法では、クエリに関連性が高く、かつ、すでに選択された文書との類似性が低い文書を優先的に選ぶ。
このとき、選択される文書の「周辺関連性 (marginal relevance)」は高くなる。

「周辺関連性」とは、文書の関連性と新規性を独立して評価し、それらを線形結合した尺度を指す。
この考え方では、「関連新規性 (relevance novelty)」という視点が取り入れられており、単にクエリとの関連性だけで評価される従来の手法では埋もれてしまいがちな文書も適切に評価されるようになっている。

この仕組みにより、ユーザーのクエリに合致するだけでなく、多様な視点を持つ文書を効果的に選び出すことが可能となる。

\begin{equation}
    \text{MMR}(D_i) = \lambda \cdot \text{Sim}_1(D_i, Q) - (1 - \lambda) \cdot \max_{D_j \in S} \text{Sim}_2(D_i, D_j)
\end{equation}

\noindent
\textbf{Notation:}
\begin{itemize}
    \item $D_i$: 候補文書。
    \item $Q$: ユーザーのクエリ。
    \item $S$: すでに選択された文書の集合。
    \item $\text{Sim}_1(D_i, Q)$: 候補文書 $D_i$ とクエリ $Q$ の関連性（通常コサイン類似度や距離尺度を使用）。
    \item $\text{Sim}_2(D_i, D_j)$: 候補文書 $D_i$ と既選択文書 $D_j$ の類似性（多様性を考慮するために使用）。
    \item $\lambda$: 関連性と多様性のバランスを調整するパラメータ（$0 \leq \lambda \leq 1$）。
\end{itemize}


\subsection{結果のまとめ}

\begin{itemize}
  \item \textbf{出力結果の厳密性について}：  
    コサイン類似度は、与えられたキーワードに基づく授業の厳密な検索結果を評価する上で有効であることが確認された。特に、データセット\texttt{data3}におけるコサイン類似度は、検索結果の厳密性において他の手法と比較して最も優れていることが示唆された。これは、重要なキーワードを外すことなく、対象に非常に近い授業を適切に抽出できていることによる。

  \item \textbf{出力結果の多様性について}：
    多様性の観点からは、Minimal Marginal Relevance (MMR) 法が有効であることが分かった。キーワードに直接一致しないが関連性のある授業を探索する能力において、MMRは優位性を示した。データセット\texttt{data1〜3}におけるMMRの結果は大きな差異を示さず、一貫して多様な結果を提供することが確認された。このことから、MMRは多様性の確保において一貫した性能を発揮することが推察される。
\end{itemize}

以上の結果から、厳密性を重視する場合はコサイン類似度、多様性を重視する場合はMMRを選択するのが適切であると結論付けられる。

\begin{table}[htbp]
    \centering
    \caption{コサイン類似度とMMRの比較(データセット: \texttt{data1})}
    \label{tab:question_similarity_mmr_data1}
    {\small
    \begin{tabular}{|p{2.5cm}|p{5.5cm}|p{5.5cm}|}
        \hline
        \textbf{クエリ} & \textbf{cos類似度} & \textbf{MMR} \\ \hline
        \multirow{4}{2.5cm}{電気回路を学べる科目は何ですか？} & 
        電気・電子工学 & 電気・電子工学 \\
        & 電気電子回路 & 電磁気学B \\
        & 電気電子回路演習 & 電気電子回路 \\
        & 電気電子回路入門 & 真空電子工学 \\ \hline
        \multirow{4}{2.5cm}{機械学習を学べる授業は何ですか？} & 
        機械システム学セミナー（機） & 機械システム学セミナー（機） \\
        & パターン認識と機械学習 & 学術連携共同：数理科学の研究フロンティア \\
        & 機械学習 & パターン認識と機械学習 \\
        & 学術連携共同：数理科学の研究フロンティア & ILASセミナー ：ロボットとの未来を考える \\ \hline
        \multirow{4}{2.5cm}{脳神経について学べる科目を教えてください} & 
        神経科学の基礎 & 神経科学の基礎 \\
        & 記憶機能論 & 生物科学課題研究19 \\
        & 神経心理学 I （神経・生理心理学） & 神経生理学 \\
        & 神経心理学Ｉ & 基礎演習：神経心理学 \\ \hline
        \multirow{4}{2.5cm}{日本文学に関する授業は何がありますか？} & 
        日本語学・日本文学演習IIB & 日本語学・日本文学演習IIB \\
        & 日本語学・日本文学演習IIA & 日本語学・日本文学演習IV \\
        & 日本語学・日本文学演習IV & 英米文芸表象論演習B \\
        & 国語国文学II & 日本史学(特殊講義) \\ \hline
        \multirow{4}{2.5cm}{心理学の入門科目は何がありますか？} & 
        心理学（実習IA）(心理学実験) & 心理学（実習IA）(心理学実験) \\
        & 心理学概論 & 心理学概論 \\
        & 心理学概論 & 言語科学入門（認知情報学系入門科目） \\
        & 心理学概論 & 社会心理学（社会・集団・家族心理学） \\ \hline
        \multirow{4}{2.5cm}{ビジネス関連の授業は何がありますか？} & 
        企業分析 & 企業分析 \\
        & 商法（総則・商行為） & 商法（総則・商行為） \\
        & ビジネスエシックス & ビジネスエシックス \\
        & 商法（会社） & アントレプレナーシップ特論 \\ \hline
        \multirow{4}{2.5cm}{環境問題について学べる授業を探しています。} & 
        環境学 & 環境学 \\
        & 国際環境政治学 & 演習(4回生) \\
        & 基礎地球科学B （地球システムと環境） & 地球生存リスク特論 \\
        & 演習(4回生)テーマ：エネルギー & 環境法 \\ \hline
    \end{tabular}
    }
\end{table}

\begin{table}[htbp]
    \centering
    \caption{クエリに基づくcos類似度とMMRの比較(データセット: \texttt{data2})}
    \label{tab:query_similarity_mmr_data2}
    {\small
    \begin{tabular}{|p{2.5cm}|p{5.5cm}|p{5.5cm}|}
        \hline
        \textbf{クエリ} & \textbf{cos類似度} & \textbf{MMR} \\ \hline
        \multirow{4}{2.5cm}{電気回路を学べる科目は何ですか？} & 
        電気・電子工学 & 電気・電子工学 \\
        & 電気電子回路 & 電気電子回路 \\
        & 電気電子回路入門 & 電気回路基礎論 \\
        & 電気回路 & \\ \hline
        \multirow{4}{2.5cm}{機械学習を学べる授業は何ですか？} & 
        機械学習 & 機械学習 \\
        & パターン認識と機械学習 & 機械製作実習（機） \\
        & データ分析演習Ｉ & データ分析演習Ｉ \\
        & 人工知能 & 機械学習 \\ \hline
        \multirow{4}{2.5cm}{脳神経について学べる科目を教えてください} & 
        神経科学の基礎 & 神経科学の基礎 \\
        & 心理学(特殊講義A)（神経・生理心理学） & ILASセミナー ：神経心理学 \\
        & 神経心理学 I （神経・生理心理学） & 神経生理学の基礎 −生体情報論− \\
        & 神経心理学Ｉ & 霊長類学入門Ｉ \\ \hline
        \multirow{4}{2.5cm}{脳神経について学べる科目は何ですか？} & 
        神経科学の基礎 & 神経科学の基礎 \\
        & 神経生理学の基礎 −生体情報論− & 神経生物学 \\
        & 神経科学の基礎 & 記憶神経科学ゼミA \\
        & 記憶神経科学ゼミＢ & 神経生理学の基礎 −生体情報論− \\ \hline
        \multirow{4}{2.5cm}{神経科学について学べる科目はなんですか？} & 
        神経科学の基礎 & 神経科学の基礎 \\
        & 神経科学の基礎 & 神経生理学 \\
        & 神経生物学 & 神経生物学 \\
        & 神経生理学の基礎 −生体情報論 & 神経生物学の \\ \hline
        \multirow{4}{2.5cm}{日本文学に関する授業は何がありますか？} & 
        日本の歴史と文化 & 日本の歴史と文化 \\
        & 日本語学・日本文学演習IV A & 言学Ｉ \\
        & 日本語学・日本文学演習IV B & 基礎演習：日本近代文学 \\
        & メディア文化学(特殊講義) & 日本語学・日本文学IIIA \\ \hline
        \multirow{4}{2.5cm}{日本文学を学べる授業は何がありますか？} & 
        基礎演習：日本近代文学 & 基礎演習：日本近代文学 \\
        & 基礎演習：日本近代文学 & 日本語学・日本文学演習IIIB \\
        & 日本近代文学II & 日本語学・日本文学演習IV A \\
        & 日本近代文学II & 日本語学・日本文学IIIA \\ \hline
        \multirow{4}{2.5cm}{心理学の入門科目は何がありますか？} & 
        心理学概論 & 心理学概論 \\
        & 心理学概論 & ILASセミナー ：社会心理学 \\
        & 系共通科目(心理学)(講義Ｉ) & 心理学(演習)（心理演習） \\
        & 基礎演習：社会心理学 & 基礎演習：社会心理学 \\ \hline
        \multirow{4}{2.5cm}{ビジネス関連の授業は何がありますか？} & 
        商法（総則・商行為） & 商法（総則・商行為） \\
        & 商法（会社） & ビジネスのための情報システム \\
        & 商法（会社）【旧商法第二部】 & AI技術利活用実践 \\
        &  & ビジネスエシックス \\ \hline
        \multirow{4}{2.5cm}{生物学の実験を含む授業は何ですか？} & 
        細胞と分子の基礎生物学実験 & 細胞と分子の基礎生物学実験 \\
        & 実験動物学 & 生物・生命科学入門 \\
        & 生物学実習Ｉ ［基礎コース］ & 実験動物学 \\
        & 生物学実習Ｉ ［基礎コース］ & 生物学実習Ｂ \\ \hline
        \multirow{4}{2.5cm}{環境問題について学べる授業を探しています。} & 
        環境学 & 環境学 \\
        & 環境学 & 演習(3回生) \\
        & 統合科学 ：持続可能な地球社会をめざして & 環境と法 \\
        & 環境動態学 & 自然と環境の化学 \\ \hline
        \multirow{4}{2.5cm}{環境問題について学べる授業は何ですか？} & 
        環境学 & 環境法 \\
        & 環境学 & 森林環境学 \\
        & 環境と法 & \\
        & 環境と法 & \\ \hline
    \end{tabular}
    }
\end{table}

\begin{table}[htbp]
    \centering
    \caption{コサイン類似度とMMRの比較(データセット: \texttt{data3})}
    \label{tab:question_similarity_mmr_data3}
    {\small
    \begin{tabular}{|p{2.5cm}|p{5.5cm}|p{5.5cm}|}
        \hline
        \textbf{クエリ} & \textbf{cos類似度} & \textbf{MMR} \\ \hline
        \multirow{4}{2.5cm}{電気回路を学べる科目は何ですか？} & 
        電気回路基礎論 & 電気回路基礎論 \\
        & 電気回路 & 電気電子回路 \\
        & 電気・電子工学 & 電気・電子工学 \\
        & 電気電子回路入門 & 電気回路 \\ \hline
        \multirow{4}{2.5cm}{機械学習を学べる授業は何ですか？} & 
        機械学習 & 機械学習 \\
        & 機械学習 & 機械製作実習（機） \\
        & パターン認識と機械学習 & パターン認識と機械学習 \\
        & パターン認識と機械学習 & 機械システム学セミナー（機） \\ \hline
        \multirow{4}{2.5cm}{脳神経について学べる科目を教えてください} & 
        神経科学の基礎 & 神経科学の基礎 \\
        & 神経科学の基礎 & 心理学(特殊講義B)(神経・生理心理学) \\
        & 心理学(特殊講義B)(神経・生理心理学) & 神経生理学の基礎 −生体情報論− \\
        & 神経生理学の基礎 −生体情報論− & 系共通科目(心理学)(講義Kc)(知覚・認知心理学) \\ \hline
        \multirow{4}{2.5cm}{脳神経について学べる科目は何ですか？} & 
        神経科学の基礎 & 神経科学の基礎 \\
        & 神経科学の基礎 & 神経生物学 \\
        & 神経科学の基礎 & 記憶神経科学ゼミA \\
        & 神経生理学の基礎 −生体情報論− & 神経生理学の基礎 −生体情報論− \\ \hline
        \multirow{4}{2.5cm}{神経科学について学べる科目はなんですか？} & 
        神経科学の基礎 & 神経科学の基礎 \\
        & 神経科学の基礎 & 神経生物学 \\
        & 神経科学の基礎 & 神経生理学I \\
        & 神経科学の基礎 & 記憶神経科学ゼミA \\ \hline
        \multirow{4}{2.5cm}{日本文学に関する授業は何がありますか？} & 
        日本語学・日本文学演習IIB & 日本語学・日本文学演習IIB \\
        & 日本語学・日本文学演習IV B & 日本語学・日本文学演習IV B \\
        & 日本語学・日本文学演習IIB & 日本の歴史と文化 \\
        & 日本語学・日本文学演習IV A & 日本語学・日本文学演習IV B \\ \hline
        \multirow{4}{2.5cm}{日本文学を学べる授業は何がありますか？} & 
        日本語学・日本文学演習IIB & 日本語学・日本文学演習IIB \\
        & 日本語学・日本文学演習IIB & 本語学・日本文学演習IV B \\
        & 日本語学・日本文学演習IIA & 国語学国文学(演習) \\
        & 日本語学・日本文学演習IV B & 日本の歴史と文化 \\ \hline
        \multirow{4}{2.5cm}{心理学の入門科目は何がありますか？} & 
        基礎演習：社会心理学 & 基礎演習：社会心理学 \\
        & 心理学概論 & 心理学概論 \\
        & 系共通科目(心理学)(講義Kc)（知覚・認知心理学） & 系共通科目(心理学)(講義Ｉ) \\
        & 心理学概論 & 心理学概論 \\ \hline
        \multirow{4}{2.5cm}{ビジネス関連の授業は何がありますか？} & 
        商法（総則・商行為） & 商法（総則・商行為） \\
        & ビジネスエシックス & 演習(4回生) \\
        & 起業と事業創造 & 医療ビジネス・イノベーション概論 \\
        & 商法（総則・商行為） & Business English-E3 \\ \hline
        \multirow{4}{2.5cm}{生物学の実験を含む授業は何ですか？} & 
        生物学実習Ｉ ［基礎コース］ & 生物学実習Ｉ ［基礎コース］ \\
        & 細胞と分子の基礎生物学実験 & 個体の基礎生物学実験 \\
        & 個体の基礎生物学実験 & 生物物理学 \\
        & 生物先端科学実験及び実験法II & 分子生物学実験及び実験法 \\ \hline
        \multirow{4}{2.5cm}{環境問題について学べる授業を探しています。} & 
        環境学 & 環境学 \\
        & 国際環境政治学 & Human-environmental Interactions-E2 \\
        & 環境学 & 環境法 \\
        & 環境法 & 基礎地球科学B(地球システムと環境) \\ \hline
        \multirow{4}{2.5cm}{環境問題について学べる授業は何ですか？} & 
        環境学 & 環境学 \\
        & 環境学 & 環境法 \\
        & 環境学 & 大気・地球環境工学 \\
        & 環境と法 & 演習(4回生) \\ \hline
    \end{tabular}
    }
\end{table}


\section{単語出現頻度に基づく検索手法の実験}

\subsection{BM25（Best Matching 25）とは}
BM25\cite{isshiki2024bm25}は、情報検索において文書の関連性を評価する上で広く用いられる手法である。
文書内の単語の出現頻度（TF; Term Frequency）と、その単語がコーパス内のどのくらいの文書に含まれているかを示す逆文書頻度（IDF; Inverse Document Frequency）を組み合わせることで、各単語の重要度を数値化する。
この計算式には、$k_1$と$b$という調整可能なパラメータが含まれており、特に$k_1$は、TFの重み付けを調整する役割を持つ。
$k_1$の値が大きいほど、TFの影響が大きくなり、単語の出現頻度が高い文書ほど高いスコアが得られやすくなる。
また、$b$は文書長の正規化パラメータであり、$b$が大きいほど、文書長がスコアに与える影響が大きくなる。
今回はそのパラメータを調節しどの程度が良いか結論づける。

\begin{equation}
    \text{BM25}(q, d) = \sum_{t \in q} \text{IDF}(t) \cdot \frac{f(t, d) \cdot (k_1 + 1)}{f(t, d) + k_1 \cdot \left(1 - b + b \cdot \frac{|d|}{\text{avgdl}}\right)}
\end{equation}

\noindent
\textbf{Notation:}
\begin{itemize}
    \item $q$: クエリ
    \item $d$: 文書
    \item $t$: クエリ内の単語
    \item $f(t, d)$: 文書 $d$ 内の単語 $t$ の出現頻度
    \item $|d|$: 文書 $d$ の長さ（単語数）
    \item $\text{avgdl}$: コーパス内の文書の平均長
    \item $N$: コーパス内の文書総数
    \item $n(t)$: 単語 $t$ を含む文書の数
    \item $k_1$: 文書の調整パラメータ（通常 $k_1 = 1.2$）
    \item $b$: 文書長の正規化パラメータ（通常 $b = 0.75$）
\end{itemize}

\subsection{実験結果・考察}
ここでは「電気回路を学べる科目は何ですか」という質問に対して、$k_1 = 1, 3, 5, 10$ という4つのパラメータを用いてBM25を適用した結果について述べる。
$k_1 = 1$とした場合は、稀な単語の影響が大きくなり、関係のない科目が上位に表示される傾向が見られた。
$k_1$の値を次第に大きくしていくと、関連のない科目が上位に表示される割合が減少し、関連のある科目が上位に表示される割合が増加することが確認された。

BM25による検索ではキーワードが合致していないとなかなか適合せず、抽象的な質問には答えることができないようで、シラバスRAGの検索手法でそのままBM25を用いるのは、実用としては難しいと思った。
そのため、キーワードを抜き出し検索したり、生成AIでシラバスに含まれそうなキーワードを増幅したりしながら、抽象的なクエリに対して検索をもっと工夫する必要があると思った。

\begin{table}[htbp]
    \centering
    \caption{パラメータ \( k_1 \) による検索結果の比較}
    \label{tab:question_response_comparison}
    {\small
    \begin{tabular}{|p{2cm}|p{2.7cm}|p{2.7cm}|p{2.7cm}|p{2.7cm}|}
        \hline
        \textbf{クエリ} & \textbf{\( k_1=1 \)} & \textbf{\( k_1=3 \)} & \textbf{\( k_1=5 \)} & \textbf{\( k_1=10 \)} \\ \hline
        \multirow{5}{2cm}{電気回路を学べる科目は何ですか？} & 
        電気電子回路入門 & 電気電子回路入門 & 電気電子回路入門 & 電気電子回路入門 \\
        & フランス語IIＢ & 電気・電子工学 & 電気・電子工学 & 電気・電子工学 \\
        & 応用生命科学入門I & 電気電子工学基礎実験 & 電気電子工学基礎実験 & 電気電子工学基礎実験 \\
        & 電子回路 & フランス語IIＢ & 電気回路基礎論 & 電気電子回路 \\
        & ビルマ(ミャンマー)語I(初級)(語学) & 電気機器基礎論 & 電気電子回路 & 電気回路基礎論 \\ \hline
        \multirow{5}{2cm}{機械学習を学べる授業は何ですか？} & 
        学術連携共同：数理科学の研究フロンティア & フランス語IIＢ & フランス語IIＢ & 行動生態学入門 \\
        & 英語リーディング & 英語リーディング & 行動生態学入門 & フランス語IIＢ \\
        & 英語リーディング & 行動生態学入門 & 英語リーディング & 欧米経済史 \\
        & ヒューマンインタフェースの心理と生理 & ヒューマンインタフェースの心理と生理 & 地震学 & 地震学 \\
        & フランス語IIＢ & ILASセミナー：障害とは何か & ヒューマンインタフェースの心理と生理 & 欧米経済史 \\ \hline
    \end{tabular}
    }
\end{table}
